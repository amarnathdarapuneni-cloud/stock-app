<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stock What-If Calculator</title>
  <style>
    :root {
      --bg: #070b1a;
      --panel: #101936;
      --panel-soft: #182347;
      --text: #ebf0ff;
      --muted: #9fb0dd;
      --accent: #67e8f9;
      --accent-2: #6366f1;
      --profit: #4ade80;
      --loss: #fb7185;
      --warning-bg: rgba(251, 113, 133, 0.14);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: Inter, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(circle at 10% 10%, rgba(99, 102, 241, 0.24), transparent 30%),
        radial-gradient(circle at 85% 15%, rgba(103, 232, 249, 0.18), transparent 35%),
        var(--bg);
      color: var(--text);
      padding: 1.5rem;
    }

    .container {
      max-width: 1080px;
      margin: 0 auto;
      display: grid;
      gap: 1rem;
    }

    .hero {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.24), rgba(103, 232, 249, 0.12));
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 1.2rem;
      box-shadow: 0 15px 50px rgba(3, 8, 30, 0.35);
    }

    h1 { margin: 0; font-size: 1.8rem; }
    .sub { color: var(--muted); margin-top: 0.4rem; }

    .layout {
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 1rem;
      align-items: start;
    }

    .panel {
      background: rgba(16, 25, 54, 0.95);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 1rem;
    }

    form { display: grid; gap: 0.8rem; }
    label { font-size: 0.9rem; color: var(--muted); }

    input, select, button {
      width: 100%;
      margin-top: 0.3rem;
      padding: 0.62rem;
      font-size: 0.97rem;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.12);
      background: var(--panel-soft);
      color: var(--text);
    }

    button {
      border: none;
      background: linear-gradient(135deg, var(--accent-2), #3b82f6);
      cursor: pointer;
      font-weight: 600;
      transition: transform .12s ease;
    }

    button:hover { transform: translateY(-1px); }

    .error {
      background: var(--warning-bg);
      border: 1px solid rgba(251, 113, 133, 0.4);
      color: #ffd1dc;
      border-radius: 10px;
      padding: 0.7rem;
      margin-top: 0.5rem;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.7rem;
      margin-top: 0.8rem;
    }

    .kpi {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      padding: 0.65rem;
    }

    .kpi .label { color: var(--muted); font-size: 0.78rem; }
    .kpi .value { margin-top: 0.3rem; font-weight: 700; }

    .profit { color: var(--profit); }
    .loss { color: var(--loss); }

    .chart-wrap {
      margin-top: 0.7rem;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: 0.7rem;
    }

    canvas { width: 100%; height: 290px; display: block; }

    .section-title { margin: 0; font-size: 1rem; }

    .gainers { margin-top: 0.8rem; display: grid; gap: 0.6rem; }

    .gainer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      padding: 0.58rem 0.7rem;
    }

    .chip {
      background: rgba(103, 232, 249, 0.18);
      border: 1px solid rgba(103, 232, 249, 0.5);
      color: #c8f9ff;
      border-radius: 999px;
      padding: 0.18rem 0.5rem;
      font-size: 0.78rem;
    }

    .muted { color: var(--muted); }

    @media (max-width: 920px) {
      .layout { grid-template-columns: 1fr; }
      .kpi-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <main class="container">
    <section class="hero">
      <h1>Stock What-If Dashboard</h1>
      <p class="sub">Run investment scenarios, see 1-year trend lines, and watch the strongest recent performers from your tracked list.</p>
    </section>

    <section class="layout">
      <aside class="panel">
        <h2 class="section-title">Investment Simulator</h2>
        <p class="muted">Select a ticker, a historical date, and an amount.</p>

        <form method="post">
          <div>
            <label for="symbol">Ticker</label>
            <select id="symbol" name="symbol" required>
              {% for ticker in tickers %}
                <option value="{{ ticker }}" {% if request.form.get('symbol', tickers[0]) == ticker %}selected{% endif %}>{{ ticker }}</option>
              {% endfor %}
            </select>
          </div>

          <div>
            <label for="invest_date">Investment date</label>
            <input id="invest_date" type="date" name="invest_date" max="{{ today }}" value="{{ request.form.get('invest_date', '') }}" required>
          </div>

          <div>
            <label for="amount">Amount (USD)</label>
            <input id="amount" type="number" name="amount" min="1" step="0.01" placeholder="1000" value="{{ request.form.get('amount', '') }}" required>
          </div>

          <button type="submit">Calculate Outcome</button>
        </form>

        {% if error %}
          <div class="error">{{ error }}</div>
        {% endif %}

        <h3 class="section-title" style="margin-top:1rem;">Top 3 (1Y Return)</h3>
        <div id="gainers" class="gainers muted">Loading top gainers...</div>
      </aside>

      <section class="panel">
        {% if result %}
          <h2 class="section-title">{{ result.symbol }} Position Summary</h2>
          <div class="kpi-grid">
            <div class="kpi"><div class="label">Amount Invested</div><div class="value">${{ "%.2f"|format(result.amount) }}</div></div>
            <div class="kpi"><div class="label">Buy Date Used</div><div class="value">{{ result.buy_date }}</div></div>
            <div class="kpi"><div class="label">Buy Price</div><div class="value">${{ "%.2f"|format(result.buy_price) }}</div></div>
            <div class="kpi"><div class="label">Shares Purchased</div><div class="value">{{ result.shares }}</div></div>
            <div class="kpi"><div class="label">Current Price</div><div class="value">${{ "%.2f"|format(result.current_price) }}</div></div>
            <div class="kpi"><div class="label">Value Today</div><div class="value">${{ "%.2f"|format(result.current_value) }}</div></div>
            <div class="kpi" style="grid-column: 1 / -1;">
              <div class="label">Gain / Loss</div>
              <div class="value {{ 'profit' if result.gain_loss >= 0 else 'loss' }}">
                ${{ "%.2f"|format(result.gain_loss) }} ({{ "%.2f"|format(result.gain_loss_pct) }}%)
              </div>
            </div>
          </div>
        {% else %}
          <h2 class="section-title">No simulation yet</h2>
          <p class="muted">Use the form to generate an investment scenario. You'll see performance details and chart data instantly.</p>
        {% endif %}

        <div class="chart-wrap">
          <h3 class="section-title">1-Year Price Trend</h3>
          <p id="chartStatus" class="muted">Loading chart...</p>
          <canvas id="priceChart" width="900" height="320" aria-label="1-year stock chart"></canvas>
        </div>
      </section>
    </section>
  </main>

  <script>
    const symbolEl = document.getElementById('symbol');
    const chartStatus = document.getElementById('chartStatus');
    const chartCanvas = document.getElementById('priceChart');
    const ctx = chartCanvas.getContext('2d');

    function formatMoney(v) {
      return `$${Number(v).toFixed(2)}`;
    }

    function drawChart(data) {
      const prices = data.prices || [];
      if (!prices.length) {
        chartStatus.textContent = 'No chart data available.';
        return;
      }

      const w = chartCanvas.width;
      const h = chartCanvas.height;
      ctx.clearRect(0, 0, w, h);

      const pad = 34;
      const min = Math.min(...prices);
      const max = Math.max(...prices);
      const range = (max - min) || 1;

      ctx.strokeStyle = 'rgba(255,255,255,0.24)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(pad, pad);
      ctx.lineTo(pad, h - pad);
      ctx.lineTo(w - pad, h - pad);
      ctx.stroke();

      const gradient = ctx.createLinearGradient(0, 0, w, 0);
      gradient.addColorStop(0, '#67e8f9');
      gradient.addColorStop(1, '#6366f1');
      ctx.strokeStyle = gradient;
      ctx.lineWidth = 2.4;
      ctx.beginPath();

      prices.forEach((p, i) => {
        const x = pad + (i / (prices.length - 1 || 1)) * (w - 2 * pad);
        const y = h - pad - ((p - min) / range) * (h - 2 * pad);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();

      ctx.fillStyle = '#9fb0dd';
      ctx.font = '12px sans-serif';
      ctx.fillText(formatMoney(max), 5, pad + 2);
      ctx.fillText(formatMoney(min), 5, h - pad);
      chartStatus.textContent = `${symbolEl.value}: 1Y low ${formatMoney(min)} â€¢ 1Y high ${formatMoney(max)}`;
    }

    async function loadChart() {
      chartStatus.textContent = 'Loading chart...';
      try {
        const res = await fetch(`/stock?symbol=${encodeURIComponent(symbolEl.value)}`);
        const data = await res.json();
        if (!res.ok || data.error) {
          chartStatus.textContent = 'Unable to load chart data right now.';
          return;
        }
        drawChart(data);
      } catch (e) {
        chartStatus.textContent = 'Unable to load chart data right now.';
      }
    }

    async function loadTopGainers() {
      const container = document.getElementById('gainers');
      try {
        const res = await fetch('/top-gainers');
        const gainers = await res.json();
        if (!res.ok || !Array.isArray(gainers) || !gainers.length) {
          container.textContent = 'No gainers available.';
          return;
        }
        container.innerHTML = gainers.map((g, idx) => `
          <div class="gainer">
            <div><strong>#${idx + 1} ${g.ticker}</strong></div>
            <div class="chip">${Number(g.return).toFixed(2)}%</div>
          </div>`).join('');
      } catch {
        container.textContent = 'Unable to load gainers.';
      }
    }

    symbolEl.addEventListener('change', loadChart);
    loadChart();
    loadTopGainers();
  </script>
</body>
</html>
